# 公考错题复盘系统 设计说明书

## 1. 引言

### 1.1 编写目的
本文档旨在详细阐述“公考错题复盘”APP的系统架构、功能设计、数据库设计及核心算法逻辑，为软件开发、测试及后续维护提供技术依据。同时，本文档作为软件著作权申请的重要参考材料，明确软件的技术实现细节。

### 1.2 项目背景
公考备考过程中，考生往往面临错题整理耗时、复习无体系、计算能力薄弱等问题。本软件通过数字化手段，结合OCR识别、图像处理与记忆曲线算法，提供一站式错题管理与能力提升解决方案。

### 1.3 术语定义
*   **OCR (Optical Character Recognition)**：光学字符识别，将图片转化为可编辑文本。
*   **Room**：Google Jetpack 组件中的数据库ORM框架。
*   **MVVM**：Model-View-ViewModel 架构模式。

---

## 2. 总体设计

### 2.1 系统架构
本系统采用标准的 **Android MVVM** 架构，确保代码的解耦与可维护性。

*   **表现层 (View)**：负责 UI 展示与用户交互，包含 Activity、Fragment、CustomView（如 `DrawingOverlayView`）。
*   **视图模型层 (ViewModel)**：负责业务逻辑处理与数据持有，通过 `LiveData` 或 `StateFlow` 通知 View 层更新。
*   **模型层 (Model)**：
    *   **Repository**：数据仓库，统一管理数据来源（本地数据库/网络API）。
    *   **Local Data Source**：基于 Room 的 SQLite 数据库。
    *   **Remote Data Source**：基于 Retrofit 的 RESTful API 客户端。

### 2.2 运行环境
*   **操作系统**：Android 7.0 (API Level 24) 及以上。
*   **开发语言**：Kotlin 1.9。
*   **核心库**：Android Jetpack (Room, Lifecycle, ViewModel, WorkManager), ML Kit, OkHttp/Retrofit, MPAndroidChart, Glide。

---

## 3. 系统详细设计

### 3.1 功能模块划分
1.  **题目采集模块**：相机拍摄、相册导入、悬浮窗截题。
2.  **图片处理模块**：智能裁剪、手写标注、图像旋转。
3.  **题库管理模块**：增删改查、标签管理、OCR识别、搜索。
4.  **复习训练模块**：记忆卡片（Flashcards）、数学速算练习。
5.  **会员服务模块**：Pro功能验证、云端同步。

### 3.2 核心业务流程与详细步骤

#### (1) 悬浮窗截题流程
该功能允许用户在不离开第三方刷题应用的情况下采集错题。

**详细步骤**：
1.  **权限检查**：应用启动 `FloatingCaptureService`，检查是否拥有 `SYSTEM_ALERT_WINDOW` 权限，若无则跳转系统设置页。
2.  **悬浮窗初始化**：使用 `WindowManager` 添加一个全局悬浮 `View` (Layout: `layout_floating_capture`)，显示悬浮球。
3.  **用户交互**：
    *   用户点击悬浮球触发 `startCapture()`。
    *   服务发送 `Intent` 启动透明的 `ScreenCaptureActivity`。
4.  **屏幕截取**：
    *   申请 `MEDIA_PROJECTION` 权限。
    *   获得权限后，使用 `MediaProjection` API 获取当前屏幕的 `VirtualDisplay`。
    *   将屏幕内容渲染至 `ImageReader` 的 `Surface`，捕获一帧 `Bitmap`。
5.  **区域选择**：
    *   将捕获的全屏图片传递给 `SelectRegionActivity`。
    *   用户在屏幕上拖动矩形框，确定题目区域。
6.  **裁剪保存**：
    *   根据选定区域坐标 `(x, y, w, h)` 从原 Bitmap 中裁剪出子图。
    *   保存子图至本地存储，生成 `Question` 对象插入数据库。

#### (2) 数学速算题目生成算法
系统内置 `MathQuestionGenerator`，支持30种题型生成。

**详细步骤（以“基期比重”题目为例）**：
1.  **参数随机化**：
    *   生成现期量 `current`：随机取 `[100, 1000)` 整数。
    *   生成增长量 `growth`：随机取 `[1, 100)` 整数。
2.  **基期计算**：计算基期值 `base = current - growth`。
3.  **答案计算**：计算基期比重 `answer = base / (base + current)`。
4.  **题目构建**：格式化题干字符串 `"基期: $base, 现期: $current"`。
5.  **类型标记**：标记题目类型为 `PracticeType.BASE_PERIOD_PROPORTION`。
6.  **校验**：确保生成数值逻辑自洽（如分母不为零），否则递归重新生成。

#### (3) 手写标注与图层叠加
实现在图片上模拟纸笔书写的核心逻辑。

**详细步骤**：
1.  **View与Canvas初始化**：自定义 `DrawingOverlayView`，初始化 `Bitmap`（透明背景）和 `Canvas`。
2.  **触摸事件处理 (`onTouchEvent`)**：
    *   `ACTION_DOWN`：创建新 `Path`，移动到触摸点 `(x, y)`。
    *   `ACTION_MOVE`：使用贝塞尔曲线 (`quadTo`) 平滑连接路径点。
    *   `ACTION_UP`：保存当前 `Path` 和 `Paint` 属性（颜色、粗细）到 `allPaths` 列表，支持后续撤销。
3.  **颜色管理**：定义颜色映射表（红#FF3B30、蓝#007AFF等），切换时更新 `Paint.color`。
4.  **橡皮擦逻辑**：设置 Paint 的 `Xfermode` 为 `PorterDuff.Mode.CLEAR`，使得绘制路径处的像素变透明。
5.  **图层合并与导出**：
    *   **显示时**：先绘制原图 Bitmap，再在上层绘制标注 Bitmap。
    *   **保存时**：将标注 Bitmap 独立保存为 `.png` 文件（保留透明通道），更新数据库 `annotationPath` 字段。

---

## 4. 数据库设计 (Database Design)

本系统使用 SQLite (Room) 数据库，数据库名为 `snap_review_database`，当前版本 v14。

### 4.1 表结构设计

#### 4.1.1 题目表 (`questions`)
存储所有采集的错题信息。

| 字段名 | 类型 | 说明 | 备注 |
| :--- | :--- | :--- | :--- |
| `id` | TEXT | 主键，UUID | 唯一标识符 |
| `imagePath` | TEXT | 题目当前显示图片路径 | 用于列表展示 |
| `originalImagePath` | TEXT | 原始未修改图片路径 | 用于还原 |
| `cleanedImagePath` | TEXT | 擦除手写后的图片路径 | AI去手写功能产物 |
| `annotationPath` | TEXT | 手写标注图层图片路径 | 透明背景PNG |
| `rawText` | TEXT | OCR识别文本 | 用于全文搜索 |
| `tags` | TEXT | 标签集合 | JSON格式存储 |
| `reviewState` | TEXT | 复习状态 | unreviewed/mastered |
| `createdAt` | INTEGER | 创建时间戳 | 排序用 |

#### 4.1.2 独立卡片表 (`standalone_flashcards`)
存储Anki风格的记忆卡片，包含间隔重复算法字段。

| 字段名 | 类型 | 说明 | 备注 |
| :--- | :--- | :--- | :--- |
| `id` | TEXT | 主键 | |
| `frontText` | TEXT | 正面内容 | 问题 |
| `backText` | TEXT | 背面内容 | 答案 |
| `deckId` | TEXT | 所属卡包ID | 关联 `flashcard_decks` |
| `nextReviewTime` | INTEGER | 下次复习时间 | 算法计算得出 |
| `interval` | INTEGER | 复习间隔(天) | |
| `easeFactor` | REAL | 记忆难度因子 | 默认2.5 |
| `reviewCount` | INTEGER | 复习次数 | |
| `reviewState` | TEXT | 掌握状态 | new/review/relearning |

#### 4.1.3 数学练习会话表 (`math_practice_sessions`)
记录每次数学练习的统计数据。

| 字段名 | 类型 | 说明 |
| :--- | :--- | :--- |
| `id` | TEXT | 主键 |
| `practiceType` | TEXT | 练习类型 |
| `questionCount` | INTEGER | 题目总数 |
| `correctCount` | INTEGER | 正确数量 |
| `durationSeconds` | INTEGER | 耗时(秒) |
| `accuracy` | REAL | 正确率 |
| `startTime` | INTEGER | 开始时间 |

### 4.2 数据迁移策略
系统内置完整的 `Migration` 策略（如 `MIGRATION_11_12`），支持在版本升级时无损保留用户数据。例如从 v11 升级至 v12 时，自动创建 `flashcard_decks` 表并为卡片表添加 `deckId` 字段。

---

## 5. 接口设计

### 5.1 外部接口
*   **后端 API**：
    *   `/api/redeem/verify` (POST)：验证Pro会员兑换码。
    *   `/api/redeem/activate` (POST)：激活Pro服务。
*   **输入参数**：兑换码（String）、设备ID（String）。
*   **输出参数**：JSON对象，包含 `isValid` (Boolean), `expireDate` (Long) 等。

### 5.2 内部接口
*   **ImageEditor Interface**：
    *   `crop(uri, rect)`: 裁剪图片。
    *   `rotate(uri, degrees)`: 旋转图片。
*   **QuestionRepository Interface**：
    *   `getQuestion(id)`: Flow<Question>。
    *   `insertQuestion(question)`: suspend function。

---

## 6. 安全设计
1.  **数据安全**：所有用户数据（图片、数据库）默认存储在应用私有目录 (`Context.getFilesDir()`)，外部引用无法直接访问，防止隐私泄露。
2.  **API安全**：Pro会员验证接口使用 HTTPS 加密传输，设备ID经过哈希处理，不传输原始敏感信息。

---

*文档版本：v2.1*  
*最后更新：2026年*
